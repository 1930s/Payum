# Payex

Steps:

* [Download libraries](#download-libraries)
* [Configure context](#configure-context)
* [Prepare payment](#prepare-payment)

_**Note** : We assume you followed all steps in [get it started](get-it-started.md) and your basic configuration same as described there._

## Download libraries

Run the following command:

```bash
$ php composer.phar require "payum/payex:*@stable"
```

## Configure context

```yaml
#app/config/config.yml

payum:
    contexts:
        your_context_here:
            payex:
                api:
                    options:
                        account_number:  'get this from gateway side'
                        encryption_key:  'get this from gateway side'
                        sandbox: true
            storages:
                Acme\PaymentBundle\Entity\PaymentDetails:
                    doctrine:
                        driver: orm
```

_**Attention**: You have to changed `your_payment_name` to something more descriptive and domain related, for example `post_a_job_with_payex`._

## Prepare payment

Now we are ready to prepare the payment. Here we set price, currency, cart items details and so.
Please note that you have to set details in the payment gateway specific format.

```php
<?php
//src/Acme/PaymentBundle/Controller
namespace AcmeDemoBundle\Controller;

use Symfony\Component\HttpFoundation\Request;

class PaymentController extends Controller
{
    public function preparePayexPaymentAction()
    {
        $paymentName = 'your_payment_name';

        $storage = $this->getPayum()->getStorageForClass(
            'Acme\PaymentBundle\Entity\PaymentDetails',
            $paymentName
        );

        /** @var \Acme\PaymentBundle\Entity\PaymentDetails $paymentDetails */
        $paymentDetails = $storage->createModel();
        $paymentDetails['price'] = $data['amount'] * 100;
        $paymentDetails['priceArgList'] = '';
        $paymentDetails['vat'] = 0;
        $paymentDetails['currency'] = $data['currency'];
        $paymentDetails['orderId'] = 123;
        $paymentDetails['productNumber'] = 123;
        $paymentDetails['purchaseOperation'] = OrderApi::PURCHASEOPERATION_AUTHORIZATION;
        $paymentDetails['view'] = OrderApi::VIEW_CREDITCARD;
        $paymentDetails['description'] = 'a desc';
        $paymentDetails['clientIPAddress'] = $request->getClientIp();
        $paymentDetails['clientIdentifier'] = '';
        $paymentDetails['additionalValues'] = '';
        $paymentDetails['agreementRef'] = '';
        $paymentDetails['clientLanguage'] = 'en-US';
        $storage->updateModel($paymentDetails);

        $captureToken = $this->get('payum.security.token_factory')->createCaptureToken(
            $paymentName,
            $paymentDetails,
            'acme_payment_done' // the route to redirect after capture;
        );

        $paymentDetails['returnurl'] = $captureToken->getTargetUrl();
        $paymentDetails['cancelurl'] = $captureToken->getTargetUrl();
        $storage->updateModel($paymentDetails);

        return $this->redirect($captureToken->getTargetUrl());
    }
}
```

That's it. After the payment done you will be redirect to `acme_payment_done` action.
Check [this chapter](../purchase_done_action.md) to find out how this done action could look like.

## Next Step

* [Purchase done action](../purchase_done_action.md).
* [Configuration reference](../configuration_reference.md).
* [Back to examples list](../simple_purchase_examples.md).
* [Back to index](../index.md).


















# Payex

## Download payex payum lib

Add the following lines in your `composer.json` file:

```json
{
    "require": {
        "payum/payex": "dev-master"
    }
}
```

_**Note:** You may want to adapt this line to use a specific version._

Now, run composer.phar to download the bundle:

```bash
$ php composer.phar install
```

_**Note:** You can immediately start using it. The autoloading files have been generated by composer and already included to the app autoload file._

## Step 2: Basic configuration.

### 1. Configure payment context

```yml
#app/config/config.yml

payum:
    contexts:
        your_payment_name:
            payex:
                api:
                    options:
                        account_number:  'get this from gateway side'
                        encryption_key:  'get this from gateway side'
                        sandbox: true
```

_**Attention**: You have to changed this name `your_payment_name` to something related to your domain, for example `post_a_job_with_payex`._

### 2-a. Configure doctrine storage

Extend PaymentDetails class with added id property:

```php
<?php
//src/Acme/DemoBundle/Entity

namespace AcmeDemoBundle\Entity;

use Doctrine\ORM\Mapping as ORM;
use Payum\Payex\Bridge\Doctrine\Entity\PaymentDetails;

/**
 * @ORM\Entity
 */
class PayexPaymentDetails extends PaymentDetails
{
    /**
     * @ORM\Column(name="id", type="integer")
     * @ORM\Id
     * @ORM\GeneratedValue(strategy="IDENTITY")
     */
    protected $id;
}
```

and configure storage to use this model:

```yml
#app/config/config.yml

payum:
    contexts:
        your_payment_name:
            storages:
                AcmeDemoBundle\Entity\PayexPaymentDetails:
                    doctrine:
                        driver: orm
                        payment_extension: true

doctrine:
    orm:
        entity_managers:
            default:
                mappings: 
                    payum_payex:
                        is_bundle: false
                        type: xml 
                        dir: %kernel.root_dir%/../vendor/payum/payex/src/Payum/Payex/Bridge/Doctrine/Resources/mapping
                        prefix: Payum\Payex\Bridge\Doctrine\Entity
```

### 2-b. Configure filesystem storage

Extend PaymentDetails class with added `id` property:

```php
<?php
//src/Acme/DemoBundle/Model

namespace AcmeDemoBundle\Model;

use Payum\Payex\Model\PaymentDetails;

class PayexPaymentDetails extends PaymentDetails
{
    protected $id;
    
    public function getId()
    {
        return $this->id;
    }
}
```

and configure storage to use this model:

```yaml
#app/config/config.yml

payum:
    contexts:
        your_payment_name:
            storages:
                Acme\DemoBundle\Model\PayexPaymentDetails:
                    filesystem:
                        storage_dir: %kernel.root_dir%/Resources/payments
                        id_property: id
                        payment_extension: true
```

## Step 3. Capture payment:

_**Note** : We assume you [configured capture controller](../get_it_started.md#step-3-configure-capture-controller-optional)_

_**Note** : We assume you choose a storage._

```php
<?php
//src/Acme/DemoBundle/Controller
namespace AcmeDemoBundle\Controller;

use Payum\Payex\Api\OrderApi;

class PaymentController extends Controller 
{
    public function preparePaymentAction()
    {
        $paymentName = 'your_payment_name';
    
        $storage = $this->getPayum()->getStorageForClass(
            'Acme\DemoBundle\Model\PayexPaymentDetails',
            $paymentName
        );

        /** @var $paymentDetails PaymentDetails */
        $paymentDetails = $storage->createModel();
        $paymentDetails->setPrice($data['amount'] * 100);
        $paymentDetails->setPriceArgList('');
        $paymentDetails->setVat(0);
        $paymentDetails->setCurrency($data['currency']);
        $paymentDetails->setOrderId(123);
        $paymentDetails->setProductNumber(123);
        $paymentDetails->setPurchaseOperation(OrderApi::PURCHASEOPERATION_AUTHORIZATION);
        $paymentDetails->setView(OrderApi::VIEW_CREDITCARD);
        $paymentDetails->setDescription('a desc');
        $paymentDetails->setClientIPAddress($request->getClientIp());
        $paymentDetails->setClientIdentifier('');
        $paymentDetails->setAdditionalValues('');
        $paymentDetails->setAgreementRef('');
        $paymentDetails->setClientLanguage('en-US');

        $storage->updateModel($paymentDetails);

        $captureToken = $this->get('payum.security.token_factory')->createCaptureToken(
            $paymentName,
            $paymentDetails,
            'acme_payment_done' // the route to redirect after capture;
        );

        $paymentDetails->setReturnurl($captureToken->getTargetUrl());
        $paymentDetails->setCancelurl($captureToken->getTargetUrl());
        $storage->updateModel($paymentDetails);

        return $this->redirect($captureToken->getTargetUrl());
    }
}
```

## Next Step

* [Simple purchase done action](simple_purchase_done_action.md).
* [Configuration reference](configuration_reference.md).
* [Sandbox](sandbox.md).
* [Debugging](debugging.md).
* [Back to index](index.md).