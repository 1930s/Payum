## Configure paypal express checkout payment

### Step 1. Download paypal payum lib

Add the following lines in your `composer.json` file:

```json
{
    "require": {
        "payum/paypal-express-checkout-nvp": "dev-master"
    }
}
```

**Note:** You may want to adapt this line to use a specific version.

Now, run composer.phar to download the bundle:

```bash
$ php composer.phar install
```

**Note:** You can immediately start using it. The autoloading files have been generated by composer and already included to the app autoload file.

### Step 2: Configure payum bundle

```yaml

payum:
    contexts:
        simple_sell_paypal:
            paypal_express_checkout_nvp_payment:
                api:
                    options:
                        username:  ''
                        password:  ''
                        signature: ''
                        sandbox: true
            filesystem_storage:
                model_class: Payum\Domain\SimpleSell
                storage_dir: %kernel.root_dir%\Resources\payments
                id_property: id
```

Lets describe some parts of the config. 
Payum bundle uses contexts to handle payments. 
You can have as many context as you want.
It is up to you how to name the content. 
We choose filesystem as storage, you may want to use doctrine storage.
You should take api options from [paypal](https://developer.paypal.com/) side and put them to `api.options` section. 
Also you should not forget to set `sandbox` option to false in production use. 

### Step 3: Configure create instruction action

First we have to create payum action. This action create payment specific instruction from your model. 

```php
<?php
namespace AcmeDemoBundle\Payum\Action;

use Symfony\Component\Routing\RouterInterface;

use Payum\Action\ActionPaymentAware;
use Payum\Request\CaptureRequest;
use Payum\PaymentInstructionAggregateInterface;
use Payum\PaymentInstructionAwareInterface;
use Payum\Exception\RequestNotSupportedException;
use Payum\Paypal\ExpressCheckout\Nvp\PaymentInstruction;
use Payum\Domain\SimpleSell;

class CaptureSimpleSellWithPaypalAction extends ActionPaymentAware 
{
    protected $router;
    
    public function __construct(RouterInterface $router)
    {
        $this->router = $router;
    }
    
    /**
     * {@inheritdoc}
     */
    public function execute($request)
    {        
        /** @var $request CaptureRequest */
        if (false == $this->supports($request)) {
            throw RequestNotSupportedException::createActionNotSupported($this, $request);
        }
        
        $simpleSell = $request->getModel();
        if (false == $simpleSell->getPaymentInstruction()) {
            $instruction = new PaymentInstruction();
            
            $returnUrl = $this->router->generate('payum_payment_capture', array(
                'contextName' => 'your_context',
                'modelId' => $simpleSell->getId(),
            ), $absolute = true);
            $instruction->setReturnurl($returnUrl);
            $instruction->setCancelurl($returnUrl);
    
            $instruction->setInvnum($simpleSell->getId());
            $instruction->setPaymentrequestCurrencycode(0, $simpleSell->getCurrency());
            $instruction->setPaymentrequestAmt(0,  number_format($simpleSell->getPrice())));
            
            $simpleSell->setPaymentInstruction($instruction);
        }

        $this->payment->execute(new CaptureRequest($simpleSell->getPaymentInstruction()));
    }

    /**
     * {@inheritdoc}
     */
    public function supports($request)
    {
        return
            $request instanceof CaptureRequest &&
            $request->getModel() instanceof PaymentInstructionAwareInterface &&
            $request->getModel() instanceof PaymentInstructionAggregateInterface &&
            $request->getModel() instanceof SimpleSell
        ;
    }
}
```

Second we have to add this service to container.

```yaml
services:
    payum.action.capture_simple_sell_with_paypal:
        class:                                                    AcmeDemoBundle\Payum\Action\CaptureSimpleSellWithPaypalAction
        arguments:
            -                                                     @router
            
payum:
    context:
        your_context:
            paypal_express_checkout_nvp_payment:
                #..
                actions:
                    - payum.action.capture_simple_sell_with_paypal
```

### Next Step

Now you are ready to read [how to capture payment](capture_payment.md).