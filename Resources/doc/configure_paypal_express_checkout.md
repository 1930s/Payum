## Configure paypal express checkout payment

### Step 1. Download paypal payum lib

Add the following lines in your `composer.json` file:

```json
{
    "require": {
        "payum/paypal-express-checkout-nvp": "dev-master"
    }
}
```

**Note:** You may want to adapt this line to use a specific version.

Now, run composer.phar to download the bundle:

```bash
$ php composer.phar install
```

**Note:** You can immediately start using it. The autoloading files have been generated by composer and already included to the app autoload file.

### Step 2: Configure payum bundle

```yaml

payum:
    contexts:
        simple_sell_paypal:
            paypal_express_checkout_nvp_payment:
                create_instruction_from_model_action: payum.action.create_paypal_instruction_from_simple_sell
                api:
                    options:
                        username:  ''
                        password:  ''
                        signature: ''
                        sandbox: true
            filesystem_storage:
                model_class: Payum\Domain\SimpleSell
                storage_dir: %kernel.root_dir%\Resources\payments
                id_property: id
```

Lets describe some parts of the config. 
Payum bundle uses contexts to handle payments. 
You can have as many context as you want.
It is up to you how to name the content. 
We choose filesystem as storage, you may want to use doctrine storage.
You should take api options from [paypal](https://developer.paypal.com/) side and put them to `api.options` section. 
Also you should not forget to set `sandbox` option to false in production use. 

### Step 3: Configure create instruction action

First we have to create payum action. This action create payment specific instruction from your model. 

```php
<?php
namespace AcmeDemoBundle\Payum\Action;

use Symfony\Component\Routing\RouterInterface;

use Payum\Action\ActionInterface;
use Payum\Request\CreatePaymentInstructionRequest;
use Payum\Domain\InstructionAggregateInterface;
use Payum\Domain\InstructionAwareInterface;
use Payum\Exception\RequestNotSupportedException;
use Payum\Paypal\ExpressCheckout\Nvp\PaymentInstruction;
use Payum\Domain\SimpleSell;

class CreatePaypalInstructionFromSimpleSellAction implements ActionInterface 
{
    protected $router;
    
    public function __construct(RouterInterface $router)
    {
        $this->router = $router;
    }
    
    /**
     * {@inheritdoc}
     */
    public function execute($request)
    {
        /** @var $request CreatePaymentInstructionRequest */
        if (false == $this->supports($request)) {
            throw RequestNotSupportedException::createActionNotSupported($this, $request);
        }
        
        $simpleSell = $request->getModel();
        
        $instruction = new PaymentInstruction();
        
        $returnUrl = $this->router->generate('payum_payment_capture', array(
            'contextName' => 'simple_sell_paypal',
            'modelId' => $simpleSell->getId(),
        ), $absolute = true);
        $instruction->setReturnurl($returnUrl);
        $instruction->setCancelurl($returnUrl);

        $instruction->setInvnum($simpleSell->getId());
        $instruction->setPaymentrequestCurrencycode(0, $simpleSell->getCurrency());
        $instruction->setPaymentrequestAmt(0,  number_format($simpleSell->getPrice())));

        $simpleSell->setInstruction($instruction);
    }

    /**
     * {@inheritdoc}
     */
    public function supports($request)
    {
        return
            $request instanceof CreatePaymentInstructionRequest &&
            $request->getModel() instanceof InstructionAggregateInterface &&
            $request->getModel() instanceof InstructionAwareInterface &&
            $request->getModel() instanceof SimpleSell
        ;
    }
}
```

Second we have to add this service to container.

```yaml
services:
    payum.action.create_paypal_instruction_from_simple_sell:
        class:                                                    AcmeDemoBundle\Payum\Action\CreatePaypalInstructionFromSimpleSellAction
        arguments:
            -                                                     @router
```

### Next Step

Now you are ready to read [how to capture payment](capture_payment.md).